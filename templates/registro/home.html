<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oponto - Registro de Ponto</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <!-- Ícones Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Flatpickr para seleção de datas -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            padding-top: 20px;
        }
        .card-container {
            max-width: 800px;
            margin: 0 auto 30px;
            border-radius: 15px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            border-radius: 15px 15px 0 0 !important;
        }
        #map {
            height: 300px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid #dee2e6;
            background: #f8f9fa;
        }
        .location-info {
            background-color: #f1f8fe;
            border-left: 4px solid #3498db;
            border-radius: 8px;
        }
        .btn-register {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            font-weight: 500;
            border: none;
        }
        .address-display {
            font-size: 1.1rem;
            font-weight: 500;
            color: #2c3e50;
        }
        .coordinates-display {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .point-entry {
            border-left: 3px solid;
            transition: all 0.3s;
            margin-bottom: 8px;
            padding: 12px;
            background-color: #fff;
            border-radius: 8px;
        }
        .point-type {
            border-radius: 20px;
            padding: 5px 12px;
            font-size: 0.8rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
        }
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            vertical-align: middle;
            margin-right: 5px;
        }
        .btn-history {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
            font-weight: 500;
        }
        .history-modal .modal-dialog {
            max-width: 800px;
        }
        .history-table {
            font-size: 0.9rem;
        }
        .history-table th {
            white-space: nowrap;
        }
        .date-picker {
            max-width: 200px;
        }
        .history-day-group {
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
        }
        .history-day-header {
            background-color: #f8f9fa;
            padding: 10px 15px;
            border-bottom: 1px solid #dee2e6;
            font-weight: 600;
        }
        .history-day-content {
            background-color: white;
        }
        .no-records {
            padding: 15px;
            text-align: center;
            color: #6c757d;
        }
        .filter-container {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="card card-container">
            <div class="card-header header py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-0"><i class="fas fa-fingerprint me-2"></i>Oponto</h4>
                        <p class="mb-0">Registro de Ponto Eletrônico</p>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-light text-dark">
                            <i class="fas fa-user me-1"></i> {{ user.username }}
                        </span>
                    </div>
                </div>
            </div>

            <div class="card-body">
                <!-- Alertas -->
                <div id="alertPlaceholder"></div>

                <!-- Informações de Localização -->
                <div class="location-info p-3 mb-4">
                    <h5 class="d-flex align-items-center">
                        <i class="fas fa-map-marker-alt text-primary me-2"></i>
                        Localização Atual
                    </h5>
                    <hr class="my-2">
                    <div id="address" class="address-display my-2">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                            Obtendo endereço...
                        </div>
                    </div>
                    <div id="coordinates" class="coordinates-display">
                        <i class="fas fa-globe-americas text-muted me-1"></i>
                        <span>Coordenadas: Aguardando...</span>
                    </div>
                </div>

                <!-- Mapa -->
                <div id="map"></div>

                <!-- Botão de Registrar Ponto -->
                <div class="d-grid gap-2 mt-3">
                    <button id="registerBtn" class="btn btn-register text-white py-2" disabled>
                        <i class="fas fa-plus-circle me-1"></i> REGISTRAR PONTO
                    </button>
                </div>

                <!-- Registros do Dia -->
                <div class="mt-4">
                    <h5 class="d-flex align-items-center">
                        <i class="fas fa-history text-primary me-2"></i>
                        Registros de Hoje
                    </h5>
                    <hr>
                    <div id="todayRecords">
                        <div class="text-center py-3 text-muted">
                            <i class="fas fa-clock fa-2x mb-2"></i>
                            <p>Nenhum registro encontrado para hoje</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-footer text-muted text-center">
                <button id="historyBtn" class="btn btn-history btn-sm" data-bs-toggle="modal" data-bs-target="#historyModal">
                    <i class="fas fa-calendar-alt me-1"></i> Ver Histórico
                </button>
                <small>Sistema Oponto © 2025 - Todos os direitos reservados</small>
            </div>
        </div>
    </div>
    

    <!-- Modal de Confirmação -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar Registro</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Selecione o tipo de ponto a ser registrado:</p>
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-outline-primary btn-point-type" data-type="entrada">
                            <i class="fas fa-sign-in-alt me-1"></i> Entrada
                        </button>
                        <button type="button" class="btn btn-outline-warning btn-point-type" data-type="intervalo">
                            <i class="fas fa-utensils me-1"></i> Intervalo
                        </button>
                        <button type="button" class="btn btn-outline-info btn-point-type" data-type="retorno">
                            <i class="fas fa-undo me-1"></i> Retorno
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-point-type" data-type="saida">
                            <i class="fas fa-sign-out-alt me-1"></i> Saída
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Histórico -->
    <div class="modal fade history-modal" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="historyModalLabel">
                        <i class="fas fa-history me-2"></i>Histórico de Pontos
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Filtros -->
                    <div class="filter-container mb-4">
                        <div class="row g-3">
                            <div class="col-md-5">
                                <label for="startDate" class="form-label">Data Inicial</label>
                                <input type="date" class="form-control date-picker" id="startDate">
                            </div>
                            <div class="col-md-5">
                                <label for="endDate" class="form-label">Data Final</label>
                                <input type="date" class="form-control date-picker" id="endDate">
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button id="filterBtn" class="btn btn-primary w-100">
                                    <i class="fas fa-filter me-1"></i> Filtrar
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Conteúdo do histórico -->
                    <div id="historyContent">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                            <p class="mt-2">Carregando histórico...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- Flatpickr localization -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
    
    <script>
        // Variáveis globais
        let currentPosition = null;
        let map = null;
        let confirmModal = null;
        let historyModal = null;
        
        // Configuração dos tipos de ponto
        const pointTypes = {
            'entrada': { class: 'bg-primary', icon: 'sign-in-alt', label: 'Entrada' },
            'intervalo': { class: 'bg-warning text-dark', icon: 'utensils', label: 'Intervalo' },
            'retorno': { class: 'bg-info', icon: 'undo', label: 'Retorno' },
            'saida': { class: 'bg-danger', icon: 'sign-out-alt', label: 'Saída' }
        };

        // Função para mostrar alertas
        function showAlert(message, type) {
            const alertPlaceholder = document.getElementById('alertPlaceholder');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            alertPlaceholder.innerHTML = '';
            alertPlaceholder.appendChild(alert);
            
            // Remove o alerta após 5 segundos
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Função para obter o cookie CSRF
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Função para formatar data
        function formatDate(dateString) {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR', options);
        }

        // Função para formatar hora
        function formatTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
        }

        // Função para carregar registros do dia
        function loadTodayRecords() {
            const loadingHTML = `
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-2">Carregando registros...</p>
                </div>
            `;
            
            document.getElementById('todayRecords').innerHTML = loadingHTML;
            
            fetch('/registros-hoje/')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erro ao buscar registros');
                    }
                    return response.json();
                })
                .then(data => {
                    const recordsContainer = document.getElementById('todayRecords');
                    
                    if (!data.success || !data.data || data.data.length === 0) {
                        recordsContainer.innerHTML = `
                            <div class="text-center py-3 text-muted">
                                <i class="fas fa-clock fa-2x mb-2"></i>
                                <p>Nenhum registro encontrado para hoje</p>
                            </div>
                        `;
                        return;
                    }
                    
                    recordsContainer.innerHTML = '';
                    
                    data.data.forEach((record, index) => {
                        const pointType = pointTypes[record.tipo] || pointTypes.entrada;
                        const dateTime = new Date(record.data_hora);
                        
                        const recordElement = document.createElement('div');
                        recordElement.className = 'point-entry';
                        recordElement.style.borderLeftColor = 
                            pointType.class.includes('primary') ? '#3498db' : 
                            pointType.class.includes('warning') ? '#f39c12' :
                            pointType.class.includes('danger') ? '#e74c3c' : '#3498db';
                        
                        recordElement.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="point-type ${pointType.class} me-2">
                                        <i class="fas fa-${pointType.icon} me-1"></i>
                                        ${pointType.label}
                                    </span>
                                    <span class="text-muted">
                                        ${dateTime.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}
                                    </span>
                                </div>
                                <small class="text-muted text-truncate" style="max-width: 200px;">
                                    ${record.endereco || 'Sem endereço'}
                                </small>
                            </div>
                        `;
                        
                        recordsContainer.appendChild(recordElement);
                    });
                })
                .catch(error => {
                    console.error('Erro ao carregar registros:', error);
                    document.getElementById('todayRecords').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            ${error.message || 'Erro ao carregar registros'}
                        </div>
                    `;
                });
        }

        // Função para carregar histórico
        function loadHistory(startDate = null, endDate = null) {
            const historyContent = document.getElementById('historyContent');
            historyContent.innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-2">Carregando histórico...</p>
                </div>
            `;
            
            let url = '/historico-pontos/';
            const params = new URLSearchParams();
            
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);
            
            if (params.toString()) {
                url += `?${params.toString()}`;
            }
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erro ao buscar histórico');
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data.success || !data.data || data.data.length === 0) {
                        historyContent.innerHTML = `
                            <div class="no-records">
                                <i class="fas fa-calendar-times fa-2x mb-3"></i>
                                <p>Nenhum registro encontrado no período selecionado</p>
                            </div>
                        `;
                        return;
                    }
                    
                    // Agrupa registros por dia
                    const groupedByDay = {};
                    data.data.forEach(record => {
                        const date = record.data_hora.split('T')[0];
                        if (!groupedByDay[date]) {
                            groupedByDay[date] = [];
                        }
                        groupedByDay[date].push(record);
                    });
                    
                    // Ordena as datas (mais recente primeiro)
                    const sortedDates = Object.keys(groupedByDay).sort().reverse();
                    
                    // Monta o HTML
                    let html = '';
                    sortedDates.forEach(date => {
                        const records = groupedByDay[date];
                        
                        html += `
                            <div class="history-day-group">
                                <div class="history-day-header">
                                    ${formatDate(date)}
                                    <span class="badge bg-primary ms-2">${records.length} registro${records.length > 1 ? 's' : ''}</span>
                                </div>
                                <div class="history-day-content">
                        `;
                        
                        records.forEach(record => {
                            const pointType = pointTypes[record.tipo] || pointTypes.entrada;
                            
                            html += `
                                <div class="point-entry p-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <span class="point-type ${pointType.class} me-2">
                                                <i class="fas fa-${pointType.icon} me-1"></i>
                                                ${pointType.label}
                                            </span>
                                            <span class="text-muted">
                                                ${formatTime(record.data_hora)}
                                            </span>
                                        </div>
                                        <small class="text-muted text-truncate" style="max-width: 200px;">
                                            ${record.endereco || 'Sem endereço'}
                                        </small>
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += `
                                </div>
                            </div>
                        `;
                    });
                    
                    historyContent.innerHTML = html;
                })
                .catch(error => {
                    console.error('Erro ao carregar histórico:', error);
                    historyContent.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            ${error.message || 'Erro ao carregar histórico'}
                        </div>
                    `;
                });
        }

        // Função para registrar ponto
        function registerPoint(pointType) {
            const registerBtn = document.getElementById('registerBtn');
            registerBtn.disabled = true;
            registerBtn.innerHTML = `
                <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                Registrando...
            `;
            
            const lat = currentPosition.coords.latitude;
            const lng = currentPosition.coords.longitude;
            const endereco = document.getElementById('address').textContent.trim();
            
            fetch('/registrar-ponto/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    tipo: pointType,
                    latitude: lat,
                    longitude: lng,
                    endereco: endereco
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw err; });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showAlert('Ponto registrado com sucesso!', 'success');
                    // Atualiza a lista após 0.5 segundos
                    setTimeout(loadTodayRecords, 500);
                } else {
                    throw new Error(data.error || 'Erro ao registrar ponto');
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                showAlert(error.message || 'Erro ao registrar ponto', 'danger');
            })
            .finally(() => {
                registerBtn.disabled = false;
                registerBtn.innerHTML = `
                    <i class="fas fa-plus-circle me-1"></i> REGISTRAR PONTO
                `;
            });
        }

        // Inicialização quando o DOM estiver pronto
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializa os modais
            confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
            historyModal = new bootstrap.Modal(document.getElementById('historyModal'));
            
            // Configura os date pickers
            flatpickr("#startDate", {
                dateFormat: "Y-m-d",
                locale: "pt",
                defaultDate: new Date(),
                maxDate: new Date()
            });
            
            flatpickr("#endDate", {
                dateFormat: "Y-m-d",
                locale: "pt",
                defaultDate: new Date(),
                maxDate: new Date()
            });
            
            // Configura o botão de filtro
            document.getElementById('filterBtn').addEventListener('click', function() {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                if (startDate && endDate && new Date(startDate) > new Date(endDate)) {
                    showAlert('A data inicial não pode ser maior que a data final', 'warning');
                    return;
                }
                
                loadHistory(startDate, endDate);
            });
            
            // Carrega o histórico quando o modal é aberto
            document.getElementById('historyModal').addEventListener('shown.bs.modal', function() {
                loadHistory();
            });
            
            // Inicializa o mapa
            map = L.map('map').setView([-15.788, -47.879], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);
            
            // Configura o botão de registro
            const registerBtn = document.getElementById('registerBtn');
            
            // Configura os botões de tipo de ponto
            document.querySelectorAll('.btn-point-type').forEach(btn => {
                btn.addEventListener('click', function() {
                    const pointType = this.getAttribute('data-type');
                    registerPoint(pointType);
                    confirmModal.hide();
                });
            });
            
            // Tenta obter a localização do usuário
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        currentPosition = position;
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        // Atualiza o mapa
                        map.setView([lat, lng], 18);
                        const marker = L.marker([lat, lng]).addTo(map)
                            .bindPopup("<b>Sua localização atual</b>").openPopup();
                        
                        // Círculo de precisão
                        L.circle([lat, lng], {
                            color: '#3498db',
                            fillColor: '#2980b9',
                            fillOpacity: 0.2,
                            radius: position.coords.accuracy
                        }).addTo(map);
                        
                        // Atualiza coordenadas
                        document.getElementById('coordinates').innerHTML = `
                            <i class="fas fa-globe-americas text-muted me-1"></i>
                            Coordenadas: ${lat.toFixed(6)}, ${lng.toFixed(6)}
                            <br>
                            <i class="fas fa-arrows-alt text-muted me-1"></i>
                            Precisão: ${Math.round(position.coords.accuracy)} metros
                        `;
                        
                        // Obtém endereço
                        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1`)
                            .then(response => response.json())
                            .then(data => {
                                let endereco = '';
                                if (data.address) {
                                    if (data.address.road) endereco = data.address.road;
                                    if (data.address.house_number) endereco += ', ' + data.address.house_number;
                                    if (data.address.suburb) endereco += (endereco ? ' - ' : '') + data.address.suburb;
                                    if (data.address.city) endereco += (endereco ? ' - ' : '') + data.address.city;
                                }
                                
                                const addressElement = document.getElementById('address');
                                addressElement.innerHTML = endereco 
                                    ? `<i class="fas fa-map-marker-alt text-danger me-2"></i>${endereco}`
                                    : `<i class="fas fa-exclamation-triangle text-warning me-2"></i>Endereço não disponível`;
                                
                                marker.setPopupContent(`
                                    <b>Sua localização atual</b><br>
                                    ${endereco || 'Endereço não disponível'}
                                `).openPopup();
                                
                                // Habilita botão de registro
                                registerBtn.disabled = false;
                            })
                            .catch(() => {
                                document.getElementById('address').innerHTML = `
                                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                                    Não foi possível obter o endereço completo
                                `;
                            });
                    },
                    function(error) {
                        document.getElementById('address').innerHTML = `
                            <i class="fas fa-exclamation-circle text-danger me-2"></i>
                            Erro ao obter localização: ${error.message || 'Permissão negada'}
                        `;
                        showAlert('Não foi possível obter sua localização. Por favor, habilite o GPS.', 'danger');
                    }
                );
            } else {
                document.getElementById('address').innerHTML = `
                    <i class="fas fa-exclamation-circle text-danger me-2"></i>
                    Geolocalização não suportada
                `;
                showAlert('Seu navegador não suporta geolocalização.', 'danger');
            }
            
            // Carrega os registros do dia
            loadTodayRecords();
            
            // Configura o clique no botão de registro
            document.getElementById('registerBtn').addEventListener('click', () => {
                if (currentPosition) {
                    confirmModal.show();
                } else {
                    showAlert('Aguardando obtenção da localização...', 'warning');
                }
            });
        });
    </script>
</body>
</html>