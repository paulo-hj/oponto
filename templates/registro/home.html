<!DOCTYPE html>
<html>
<head>
    <title>Oponto - Localização</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        #map { height: 400px; width: 100%; margin: 20px 0; border: 1px solid #ddd; }
        .user-info { background: #f5f5f5; padding: 15px; border-radius: 5px; }
        .error { color: red; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Bem-vindo, {{ user.username }}!</h1>
        
        <div class="user-info">
            <h3>Sua Localização Atual:</h3>
            <p id="address">Obtendo localização...</p>
            <p id="coordinates"></p>
            <p id="error" class="error"></p>
        </div>

        <div id="map"></div>

        <a href="{% url 'logout' %}">Sair</a>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const map = L.map('map').setView([0, 0], 2);  // Vista inicial do mundo
            
            // Usa OpenStreetMap (gratuito)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        // Atualiza o mapa
                        map.setView([lat, lng], 15);
                        L.marker([lat, lng]).addTo(map)
                            .bindPopup("Você está aqui!").openPopup();
                        
                        // Mostra coordenadas
                        document.getElementById('coordinates').textContent = 
                            `Latitude: ${lat.toFixed(6)}, Longitude: ${lng.toFixed(6)}`;
                        
                        // Obtém o nome da rua usando Nominatim (gratuito)
                        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.address) {
                                    let address = '';
                                    if (data.address.road) address += data.address.road + ', ';
                                    if (data.address.suburb) address += data.address.suburb + ', ';
                                    if (data.address.city) address += data.address.city;
                                    document.getElementById('address').textContent = address || 'Endereço não disponível';
                                }
                            })
                            .catch(() => {
                                document.getElementById('address').textContent = 'Não foi possível obter o endereço';
                            });
                    },
                    function(error) {
                        document.getElementById('error').textContent = 
                            'Erro ao obter localização: ' + 
                            (error.message || 'Permissão negada ou navegador não suportado');
                    }
                );
            } else {
                document.getElementById('error').textContent = 
                    'Geolocalização não suportada pelo navegador';
            }
        });
    </script>
</body>
</html>